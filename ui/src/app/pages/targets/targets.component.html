<ng-container *ngIf="{
  targets: targets$ | async,
  tasks: tasks$ | async,
  isFetching: isFetching$ | async,
  modalState: modalState$ | async
} as ctx">
  <h1 class="text-primary text-center mb-4">Cele</h1>
  <dddapp-no-data [hasContent]="!!ctx.isFetching || !!ctx.targets?.length" ctaText="Dodaj cel"
    [ctaAction]="addTarget.bind(this)">
    <button [disabled]="ctx.isFetching" (click)="addTarget()" class="d-block btn btn-outline-primary mb-4 mx-auto"
      type="button">Dodaj
      nowy</button>
    <div class="accordion accordion-flush" id="targetAccordion">
      <div class="accordion-item" *ngFor="let target of ctx.targets; index as i; trackBy: trackById">
        <h2 class="accordion-header" id="flush-headingOne">
          <button class="accordion-button fs-5 mb-2 ps-1" [class.collapsed]="openElementIndex != i" type="button"
            [ngClass]="{ 
              'success': targetsService.validateTarget(target, ctx.tasks) === TargetStateClass.SUCCESS,
              'failed': targetsService.validateTarget(target, ctx.tasks) === TargetStateClass.FAILED
            }" (click)="openElement(i)">
            <div class="d-flex flex-row align-items-center">
              <ng-container [ngSwitch]="targetsService.validateTarget(target, ctx.tasks)">
                <i *ngSwitchCase="TargetStateClass.FAILED" class="fa fa-times-circle d-inline-block me-2"
                  aria-hidden="true"></i>
                <i *ngSwitchCase="TargetStateClass.SUCCESS" class="fa fa-check-circle-o d-inline-block me-2"
                  aria-hidden="true"></i>
                <i *ngSwitchDefault class="fa fa-arrow-right d-inline-block me-2" aria-hidden="true"></i>
              </ng-container>
              <span>
                {{ target.title }}
              </span>
            </div>
          </button>
          <div class="progress">
            <div class="progress-bar" role="progressbar"
              [style.width]="getTargetProgress(target, ctx.tasks || []) * 100 + '%'"
              [attr.aria-valuenow]="getTargetProgress(target, ctx.tasks || []) * 100" aria-valuemin="0"
              aria-valuemax="100">
            </div>
          </div>
        </h2>
        <div id="flush-collapseOne" class="accordion-collapse collapse" [class.show]="openElementIndex == i"
          aria-labelledby="flush-headingOne" data-bs-parent="#targetAccordion">
          <div class="accordion-body">
            <dddapp-target-item [target]="target" [tasks]="getTargetTasks(target, ctx.tasks || [])"
              [disabled]="targetsService.validateTarget(target, ctx.tasks) === TargetStateClass.SUCCESS || targetsService.validateTarget(target, ctx.tasks) === TargetStateClass.FAILED"></dddapp-target-item>
          </div>
        </div>
      </div>
    </div>
  </dddapp-no-data>
  <dddapp-target-modal *ngIf="ctx.modalState?.isOpen" [target]="ctx.modalState?.target"></dddapp-target-modal>
</ng-container>